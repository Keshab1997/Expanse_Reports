<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expense Reports</title>
    <link rel="stylesheet" href="assets/css/style.css">
    
    <!-- ‡¶≤‡¶æ‡¶á‡¶¨‡ßç‡¶∞‡ßá‡¶∞‡¶ø ‡¶≤‡ßã‡¶° -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        .container { max-width: 1000px; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.9rem; background: white; }
        th, td { padding: 12px; border-bottom: 1px solid #eee; text-align: left; }
        th { background: #f8fafc; color: #334155; font-weight: 700; text-transform: uppercase; font-size: 0.8rem; letter-spacing: 0.5px; }
        tr:hover { background: #f1f5f9; }
        
        /* ‡¶´‡¶ø‡¶≤‡ßç‡¶ü‡¶æ‡¶∞ ‡¶¨‡¶ï‡ßç‡¶∏ ‡¶°‡¶ø‡¶ú‡¶æ‡¶á‡¶® */
        .filter-box {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 15px;
            align-items: end;
            margin-bottom: 20px;
        }
        .filter-group label { display: block; font-size: 0.8rem; color: #64748b; margin-bottom: 6px; font-weight: 600; }
        .filter-input { width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 0.9rem; background: #fff; }
        .filter-input:focus { border-color: #2563eb; outline: none; }
        
        /* ‡¶¨‡¶æ‡¶ü‡¶® ‡¶è‡¶∞‡¶ø‡ßü‡¶æ */
        .btn-area { display: flex; gap: 10px; }
        .btn-reset { background: #94a3b8; color: white; border: none; padding: 10px; border-radius: 6px; cursor: pointer; flex: 1; transition: 0.2s; }
        .btn-reset:hover { background: #64748b; }
        .btn-pdf { background: #ef4444; color: white; border: none; padding: 10px; border-radius: 6px; cursor: pointer; flex: 1; font-weight: 600; transition: 0.2s; }
        .btn-pdf:hover { background: #dc2626; }
        
        /* ‡¶∏‡¶æ‡¶Æ‡¶æ‡¶∞‡¶ø ‡¶¨‡¶æ‡¶∞ */
        .summary-bar { 
            display: flex; justify-content: space-between; align-items: center; 
            background: linear-gradient(135deg, #2563eb, #1d4ed8); 
            color: white; padding: 15px 20px; border-radius: 10px; 
            box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.2);
        }
        .cat-badge { background: #e0f2fe; color: #0284c7; padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: 600; }
    </style>
</head>
<body>

   <nav class="navbar">
    <a href="index.html" class="nav-link">Dashboard</a>
    <a href="entry.html" class="nav-link">Add Entry</a>
    <a href="list.html" class="nav-link">Reports</a>
    <!-- ‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü ‡¶¨‡¶æ‡¶ü‡¶® -->
    <a href="#" onclick="logout()" class="nav-link" style="color:red;">üö™ Logout</a>
</nav>

    <div class="container">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h2>üìä Advanced Reports</h2>
        </div>

        <!-- ‡¶´‡¶ø‡¶≤‡ßç‡¶ü‡¶æ‡¶∞ ‡¶∏‡ßá‡¶ï‡¶∂‡¶® -->
        <div class="filter-box">
            <div class="filter-group">
                <label>From Date</label>
                <input type="date" id="fromDate" class="filter-input">
            </div>
            
            <div class="filter-group">
                <label>To Date</label>
                <input type="date" id="toDate" class="filter-input">
            </div>

            <div class="filter-group">
                <label>Category</label>
                <select id="catFilter" class="filter-input">
                    <option value="">All Categories</option>
                    <!-- ‡¶°‡¶æ‡¶Ø‡¶º‡¶®‡¶æ‡¶Æ‡¶ø‡¶ï ‡¶Ö‡¶™‡¶∂‡¶® ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶Ü‡¶∏‡¶¨‡ßá -->
                </select>
            </div>

            <div class="filter-group">
                <label>Payee</label>
                <select id="payeeFilter" class="filter-input">
                    <option value="">All Payees</option>
                </select>
            </div>

            <div class="btn-area">
                <button onclick="resetFilters()" class="btn-reset" title="Clear Filters">‚Üª Reset</button>
                <button onclick="downloadPDF()" class="btn-pdf" title="Download Report">‚¨á PDF</button>
            </div>
        </div>

        <!-- ‡¶ü‡ßã‡¶ü‡¶æ‡¶≤ ‡¶¨‡¶æ‡¶∞ -->
        <div class="summary-bar">
            <span style="font-size: 0.9rem; opacity: 0.9;">Filtered Result</span>
            <span style="font-size: 1.4rem; font-weight: 700;">Total: ‚Çπ<span id="totalAmount">0</span></span>
        </div>
        
        <!-- ‡¶ü‡ßá‡¶¨‡¶ø‡¶≤ -->
        <div style="overflow-x: auto; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
            <table id="expenseTable">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Category</th>
                        <th>Payee</th>
                        <th>Purpose</th>
                        <th style="text-align: right;">Amount (‚Çπ)</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <tr><td colspan="5" style="text-align:center; padding:30px; color:#64748b;">Loading data...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- ‡¶ï‡¶®‡¶´‡¶ø‡¶ó‡¶æ‡¶∞‡ßá‡¶∂‡¶® ‡¶≤‡ßã‡¶° -->
    <script src="assets/js/config.js"></script>
    <script src="assets/js/auth.js"></script>

    <script>
        let allExpenses = [];

        // ‡ßß. ‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø ‡¶è‡¶¨‡¶Ç ‡¶è‡¶ï‡ßç‡¶∏‡¶™‡ßá‡¶®‡ßç‡¶∏ ‡¶°‡¶æ‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ
        async function loadInitialData() {
            // ‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø ‡¶≤‡ßã‡¶°
            const catSelect = document.getElementById('catFilter');
            let { data: categories } = await window.db.from('categories').select('*').order('name');
            if (categories) {
                categories.forEach(cat => {
                    const opt = document.createElement('option');
                    opt.value = cat.name;
                    opt.textContent = cat.name;
                    catSelect.appendChild(opt);
                });
            }

            // ‡¶è‡¶ï‡ßç‡¶∏‡¶™‡ßá‡¶®‡ßç‡¶∏ ‡¶°‡¶æ‡¶ü‡¶æ ‡¶≤‡ßã‡¶°
            let { data, error } = await window.db
                .from('expenses')
                .select('*')
                .order('date', { ascending: false });

            if (error) {
                console.error(error);
                alert("Error loading data. Check console.");
            } else {
                allExpenses = data;
                populatePayee(data); // ‡¶®‡¶æ‡¶Æ ‡¶°‡ßç‡¶∞‡¶™‡¶°‡¶æ‡¶â‡¶®‡ßá ‡¶¢‡ßã‡¶ï‡¶æ‡¶®‡ßã
                renderTable(data);   // ‡¶ü‡ßá‡¶¨‡¶ø‡¶≤‡ßá ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã
            }
        }

        // ‡ß®. Payee ‡¶°‡ßç‡¶∞‡¶™‡¶°‡¶æ‡¶â‡¶® ‡¶§‡ßà‡¶∞‡¶ø
        function populatePayee(data) {
            const unique = [...new Set(data.map(i => i.payee))];
            const sel = document.getElementById('payeeFilter');
            unique.sort().forEach(p => {
                const opt = document.createElement('option');
                opt.value = p;
                opt.textContent = p;
                sel.appendChild(opt);
            });
        }

        // ‡ß©. ‡¶´‡¶ø‡¶≤‡ßç‡¶ü‡¶æ‡¶∞ ‡¶≤‡¶ú‡¶ø‡¶ï
        function applyFilters() {
            const from = document.getElementById('fromDate').value;
            const to = document.getElementById('toDate').value;
            const cat = document.getElementById('catFilter').value;
            const payee = document.getElementById('payeeFilter').value;

            const filtered = allExpenses.filter(item => {
                const matchFrom = from ? item.date >= from : true;
                const matchTo = to ? item.date <= to : true;
                const matchCat = cat ? item.category === cat : true;
                const matchPayee = payee ? item.payee === payee : true;
                
                return matchFrom && matchTo && matchCat && matchPayee;
            });

            renderTable(filtered);
        }

        // ‡¶á‡¶≠‡ßá‡¶®‡ßç‡¶ü ‡¶≤‡¶ø‡¶∏‡ßá‡¶®‡¶æ‡¶∞
        ['fromDate', 'toDate', 'catFilter', 'payeeFilter'].forEach(id => {
            document.getElementById(id).addEventListener('change', applyFilters);
        });

        // ‡ß™. ‡¶ü‡ßá‡¶¨‡¶ø‡¶≤ ‡¶∞‡ßá‡¶®‡ßç‡¶°‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ
        function renderTable(data) {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = "";
            let total = 0;

            if(data.length === 0) {
                tbody.innerHTML = "<tr><td colspan='5' style='text-align:center; padding:30px; color:#ef4444;'>No records found matching your filters!</td></tr>";
                document.getElementById('totalAmount').innerText = "0";
                return;
            }

            data.forEach(item => {
                total += item.amount;
                const catDisplay = item.category ? item.category : "General";
                
                let row = `<tr>
                    <td>${item.date}</td>
                    <td><span class="cat-badge">${catDisplay}</span></td>
                    <td>${item.payee}</td>
                    <td>${item.purpose}</td>
                    <td style="text-align: right; font-weight: 700;">‚Çπ${item.amount.toLocaleString()}</td>
                </tr>`;
                tbody.innerHTML += row;
            });

            document.getElementById('totalAmount').innerText = total.toLocaleString();
        }

        // ‡ß´. ‡¶∞‡¶ø‡¶∏‡ßá‡¶ü ‡¶¨‡¶æ‡¶ü‡¶®
        function resetFilters() {
            document.getElementById('fromDate').value = "";
            document.getElementById('toDate').value = "";
            document.getElementById('catFilter').value = "";
            document.getElementById('payeeFilter').value = "";
            renderTable(allExpenses);
        }

        // ‡ß¨. ‡¶™‡¶ø‡¶°‡¶ø‡¶è‡¶´ ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° (‡¶´‡¶ø‡¶ï‡ßç‡¶∏‡¶° ‡¶´‡¶®‡ßç‡¶ü ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ)
        window.downloadPDF = function() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // ‡¶π‡ßá‡¶°‡¶æ‡¶∞
            doc.setFontSize(18);
            doc.text("Expense Report", 14, 15);
            doc.setFontSize(10);
            doc.setTextColor(100);
            doc.text("Generated: " + new Date().toLocaleDateString(), 14, 22);
            
            doc.autoTable({
                html: '#expenseTable',
                startY: 30,
                theme: 'grid',
                headStyles: { fillColor: [37, 99, 235], halign: 'center' },
                columnStyles: { 4: { halign: 'right' } }, // ‡¶è‡¶Æ‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶°‡¶æ‡¶®‡¶¶‡¶ø‡¶ï‡ßá
                
                // ‡¶è‡¶á ‡¶Ö‡¶Ç‡¶∂‡¶ü‡¶æ ‡¶´‡¶®‡ßç‡¶ü ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶†‡¶ø‡¶ï ‡¶ï‡¶∞‡ßá
                didParseCell: function (data) {
                    // ‡¶π‡ßá‡¶°‡¶æ‡¶∞ ‡¶´‡¶ø‡¶ï‡ßç‡¶∏
                    if (data.section === 'head' && data.column.index === 4) {
                        data.cell.text = "Amount (Rs)";
                    }
                    // ‡¶¨‡¶°‡¶ø ‡¶´‡¶ø‡¶ï‡ßç‡¶∏ (‚Çπ ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶æ)
                    if (data.section === 'body' && data.column.index === 4) {
                        let text = data.cell.text[0];
                        data.cell.text = text.replace('‚Çπ', '').trim();
                    }
                }
            });
            
            // ‡¶ü‡ßã‡¶ü‡¶æ‡¶≤ ‡¶´‡¶ø‡¶ï‡ßç‡¶∏
            let finalY = doc.lastAutoTable.finalY + 10;
            let totalText = document.getElementById('totalAmount').innerText.replace(/,/g, ''); 
            
            doc.setFontSize(12);
            doc.setTextColor(220, 38, 38);
            doc.text(`Total Amount: Rs. ${parseInt(totalText).toLocaleString()}`, 14, finalY);

            doc.save('Expense_Report.pdf');
        }

        // ‡¶∂‡ßÅ‡¶∞‡ßÅ
        loadInitialData();
    </script>

</body>
</html>