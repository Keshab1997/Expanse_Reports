<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add Expense</title>
    <link rel="stylesheet" href="assets/css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* ‡¶™‡ßç‡¶≤‡¶æ‡¶∏ ‡¶¨‡¶æ‡¶ü‡¶®‡ßá‡¶∞ ‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤ */
        .input-group { display: flex; gap: 10px; }
        .btn-add { background: #10b981; color: white; border: none; width: 45px; border-radius: 8px; font-size: 1.5rem; cursor: pointer; }
        
        /* ‡¶™‡¶™-‡¶Ü‡¶™ ‡¶Æ‡ßã‡¶°‡¶æ‡¶≤ ‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤ */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 20px; border-radius: 10px; width: 300px; text-align: center; }
        .modal input { margin: 15px 0; }
        .modal-btns { display: flex; gap: 10px; justify-content: center; }
        .btn-cancel { background: #ef4444; color: white; border: none; padding: 10px 15px; border-radius: 6px; cursor: pointer; }
        .btn-save-cat { background: #2563eb; color: white; border: none; padding: 10px 15px; border-radius: 6px; cursor: pointer; }
    </style>
</head>
<body>

    <nav class="navbar">
    <a href="index.html" class="nav-link">Dashboard</a>
    <a href="entry.html" class="nav-link">Add Entry</a>
    <a href="list.html" class="nav-link">Reports</a>
    <!-- ‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü ‡¶¨‡¶æ‡¶ü‡¶® -->
    <a href="#" onclick="logout()" class="nav-link" style="color:red;">üö™ Logout</a>
</nav>

    <div class="container">
        <h2>‚úçÔ∏è Add New Expense</h2>
        
        <form id="expenseForm">
            <div class="form-group">
                <label>Date</label>
                <input type="date" id="date" required>
            </div>

            <!-- ‡¶°‡¶æ‡¶Ø‡¶º‡¶®‡¶æ‡¶Æ‡¶ø‡¶ï ‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø -->
            <div class="form-group">
                <label>Category</label>
                <div class="input-group">
                    <select id="category" required>
                        <option value="">Loading...</option>
                    </select>
                    <!-- ‡¶®‡¶§‡ßÅ‡¶® ‡¶¨‡¶æ‡¶ü‡¶® -->
                    <button type="button" class="btn-add" onclick="openModal()" title="Add New Category">+</button>
                </div>
            </div>

            <div class="form-group">
                <label>Payee Name</label>
                <input type="text" id="payee" placeholder="e.g. Sandip, Abdul" required>
            </div>

            <div class="form-group">
                <label>Purpose</label>
                <input type="text" id="purpose" placeholder="e.g. Monthly Bill" required>
            </div>

            <div class="form-group">
                <label>Amount (‚Çπ)</label>
                <input type="number" id="amount" placeholder="0.00" step="0.01" required>
            </div>

            <button type="submit" class="btn-submit">Save Expense</button>
            <p id="statusMsg" class="status"></p>
        </form>
    </div>

    <!-- ‡¶®‡¶§‡ßÅ‡¶® ‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶° ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶™‡¶™-‡¶Ü‡¶™ -->
    <div id="catModal" class="modal">
        <div class="modal-content">
            <h3>Add New Category</h3>
            <input type="text" id="newCatName" placeholder="Category Name (e.g. Marketing)">
            <div class="modal-btns">
                <button class="btn-cancel" onclick="closeModal()">Cancel</button>
                <button class="btn-save-cat" onclick="saveCategory()">Save</button>
            </div>
        </div>
    </div>

    <script src="assets/js/config.js"></script>
    <script src="assets/js/auth.js"></script>
    <script>
        document.getElementById('date').valueAsDate = new Date();
        const form = document.getElementById('expenseForm');
        const statusMsg = document.getElementById('statusMsg');
        const btn = document.querySelector('.btn-submit');
        const catSelect = document.getElementById('category');

        // ‡ßß. ‡¶™‡ßá‡¶ú ‡¶≤‡ßã‡¶° ‡¶π‡¶≤‡ßá ‡¶°‡¶æ‡¶ü‡¶æ‡¶¨‡ßá‡¶∏ ‡¶•‡ßá‡¶ï‡ßá ‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø ‡¶Ü‡¶®‡¶¨‡ßá
        async function loadCategories() {
            catSelect.innerHTML = '<option value="">Select Category</option>';
            
            let { data, error } = await window.db
                .from('categories')
                .select('*')
                .order('name', { ascending: true });

            if (data) {
                data.forEach(cat => {
                    const opt = document.createElement('option');
                    opt.value = cat.name;
                    opt.textContent = cat.name;
                    catSelect.appendChild(opt);
                });
            }
        }
        loadCategories(); // ‡¶ï‡¶≤ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶≤‡ßã

        // ‡ß®. ‡¶Æ‡ßá‡¶á‡¶® ‡¶°‡¶æ‡¶ü‡¶æ ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡¶æ
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            btn.textContent = "Saving...";
            btn.disabled = true;
            statusMsg.style.display = 'none';

            const date = document.getElementById('date').value;
            const category = document.getElementById('category').value;
            const payee = document.getElementById('payee').value;
            const purpose = document.getElementById('purpose').value;
            const amount = document.getElementById('amount').value;

            const { data, error } = await window.db
                .from('expenses')
                .insert([{ date, category, payee, purpose, amount }]);

            statusMsg.style.display = 'block';
            if (error) {
                statusMsg.textContent = "‚ùå Error: " + error.message;
                statusMsg.className = "status error";
            } else {
                statusMsg.textContent = "‚úÖ Saved Successfully!";
                statusMsg.className = "status success";
                form.reset();
                document.getElementById('date').valueAsDate = new Date();
                loadCategories(); // ‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶≤‡ßã‡¶°
            }
            btn.textContent = "Save Expense";
            btn.disabled = false;
            setTimeout(() => { statusMsg.style.display = 'none'; }, 3000);
        });

        // ‡ß©. ‡¶®‡¶§‡ßÅ‡¶® ‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø ‡¶≤‡¶ú‡¶ø‡¶ï (Modal Logic)
        function openModal() { document.getElementById('catModal').style.display = 'flex'; }
        function closeModal() { document.getElementById('catModal').style.display = 'none'; }

        async function saveCategory() {
            const newName = document.getElementById('newCatName').value;
            if(!newName) return alert("Please enter a name");

            // ‡¶°‡¶æ‡¶ü‡¶æ‡¶¨‡ßá‡¶∏‡ßá ‡¶®‡¶§‡ßÅ‡¶® ‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø ‡¶∏‡ßá‡¶≠
            const { error } = await window.db
                .from('categories')
                .insert([{ name: newName }]);

            if(error) {
                alert("Error: " + error.message);
            } else {
                alert("Category Added!");
                closeModal();
                document.getElementById('newCatName').value = "";
                loadCategories(); // ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü ‡¶∞‡¶ø‡¶´‡ßç‡¶∞‡ßá‡¶∂
            }
        }
    </script>
</body>
</html>